開発を安全かつ確実に進めるため、**全6フェーズ**に分割しました。
**「まずは読み取り専用（安全）から作り、徐々に書き込み（危険）機能を追加し、最後にUIと連携させる」** という順序です。

---

### Phase 1: 環境構築と「監視機能」の実装 (ReadOnly)

**目的:** 資金を動かさず、ブロックチェーンの状態を正確に取得・計算できる土台を作る。

1. **プロジェクト初期化:**
* TypeScript, Ethers.js v5, Uniswap SDK のインストール。
* ディレクトリ構成の作成 (`src/bot`, `src/api` 等)。


2. **Hybrid Providerの実装:**
* `HTTP` (データ取得用) と `WSS` (イベント待受用) の接続クラス作成。


3. **状態取得ロジック (`monitor.ts`):**
* Poolの価格 (`slot0`)、Tick取得。
* NFTポジション情報 (`positions`)、未回収手数料の計算 (`callStatic`)。
* **重要:** 「時価総額 (Net Value)」と「含み損益」の計算ロジック実装。


4. **ロギング:**
* コンソールに綺麗にステータスが表示されるようにする。



* **✅ 完了定義:** `npm run monitor` を叩くと、リアルタイムの価格・保有資産・手数料・損益が正確にログ出力され、エラーで落ちないこと。

---

### Phase 2: コアロジック（操作機能）の実装 (Write)

**目的:** 解除・スワップ・作成の一連のアクションを実装する。**（一番バグが怖いフェーズ）**

1. **Uniswap操作ラッパー作成:**
* `DecreaseLiquidity` (解除)
* `Collect` (手数料回収)
* `SwapRouter` (不足分の両替)
* `Mint` (新規ポジション作成)


2. **リバランスフローの実装 (`rebalance.ts`):**
* 「全解除 → 手数料回収 → 50:50に計算してスワップ → 新規作成」のシーケンス制御。
* スリッページ許容値 (`0.5%`) の適用。


3. **テスト実行 (Dry Run / Fork):**
* 極少額のリアル資金で動作確認。



* **✅ 完了定義:** コマンド一発で「現在のポジションを閉じて、現在価格中心の新しいポジションを作る」動作がエラーなく完遂すること。

---

### Phase 3: APIサーバーとステート管理 (Backend)

**目的:** Botを「外から操作・参照できる」ようにする。

1. **Express/Fastify サーバー構築:**
* Botのループとは別に、HTTPリクエストを受け付けるサーバーを立てる。


2. **共有ステート (Singleton) の作成:**
* Botが見ている「最新データ」をAPI側からも参照できるようにメモリ上で共有する。


3. **エンドポイント実装:**
* `GET /status`: 最新の監視データをJSONで返す。
* `GET /config` & `POST /config`: 設定値の取得と変更。



* **✅ 完了定義:** `curl localhost:3000/status` を叩くと、Botが監視している最新情報がJSONで返ってくること。

---

### Phase 4: 安全装置と通知機能 (Safety & Notification)

**目的:** 完全放置しても資産が溶けない仕組みを作る。

1. **Discord通知機能:**
* Webhookを使って、リバランス完了時やエラー時に通知を飛ばす。


2. **自動実行トリガーの実装:**
* `monitor.ts` 内に判定ロジックを追加（範囲外 + 待機時間経過 → `rebalance.ts` を呼ぶ）。


3. **緊急停止 (Stop Loss) 実装:**
* Net Value が開始時から `x%` 減ったら、全解除してUSDC/ETHに戻し、プロセスを終了する機能。


4. **ガス代ガード:**
* ガス代が高すぎる時はリバランスをスキップする処理。



* **✅ 完了定義:** 範囲外になったらDiscordに通知が飛び、自動でリバランスが行われること。また、設定した損切りラインで自動停止すること。

---

### Phase 5: フロントエンド開発 (Dashboard)

**目的:** ログを見なくてもスマホやPCから状況を確認できるようにする。

1. **Next.js プロジェクト作成:**
* Tailwind CSS 等でUI構築。


2. **データ連携:**
* Phase 3で作ったAPI (`GET /status`) を定期的に叩いて表示更新 (SWR/TanStack Query推奨)。


3. **操作パネル:**
* 設定変更フォーム (`POST /config`)。
* 「緊急停止ボタン」の実装。



* **✅ 完了定義:** ブラウザからBotの資産状況が見れ、設定変更や停止ができること。

---

### Phase 6: 本番デプロイ (Production)

**目的:** ローカルPCを閉じても24時間365日稼働させる。

1. **Backend (Railway) デプロイ:**
* GitHub連携。環境変数の設定。
* 永続化が必要なデータ（初期投資額など）の保存場所確保 (Railway Volume or JSON DB)。


2. **Frontend (Vercel) デプロイ:**
* BackendのURLを接続。


3. **最終動作確認:**
* 本番環境での少額テスト運用開始。



* **✅ 完了定義:** クラウド上でエラーなく稼働し続け、スマホからいつでもダッシュボードにアクセスできる状態。

---

**推奨の進め方:**
まずは **Phase 1** から着手しましょう。
「現在状況が正しくAPI経由でJSONとして取得できる」ところまで（Phase 3の途中）行けば、フロントエンド開発と並行して進めることも可能です。